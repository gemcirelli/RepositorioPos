#include <TPTypedef.h>
#include <TPBase.h>
#include <TPPhone.h>
#include <TPLCD.h>
#include <TPKeypad.h>
#include <TPSerial.h>

#include "TP_DisplayAPI.h"
#include "TP_DemoDefine.h"

#ifdef INCLUDE_PHONE_SETTING
#include "TP_PhoneSetting.h"
#endif
#ifdef INCLUDE_CALL_RECORD
#include "TP_CallRecord.h"
#endif

uint8 SpeechVolume[8][206] =
{
    {
        0x14,0x44,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0xC0,0x40,0x40,0x40,
        0x40,0xC0,0x00,0x00,0xF8,0x08,0x08,0x08,
        0x08,0xF8,0x00,0x00,0xFF,0x01,0x01,0x01,
        0x01,0xFF,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
        0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,
        0x80,0x80,0x00,0x00,0xF0,0x10,0x10,0x10,
        0x10,0xF0,0x00,0x00,0xFE,0x02,0x02,0x02,
        0x02,0xFE,0x00,0x00,0xFF,0x00,0x00,0x00,
        0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,
        0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,
        0x00,0xFF,0x00,0x00,
        0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x0E,0x0A,0x0A,0x0A,0x0A,0x0E,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00
    },

    {
        0x14,0x44,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x40,0x40,0x40,0x40,0xC0,0x00,0x00,0xF8,0x08,0x08,0x08,0x08,0xF8,0x00,0x00,0xFF,0x01,0x01,0x01,0x01,0xFF,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0xF0,0x10,0x10,0x10,0x10,0xF0,0x00,0x00,0xFE,0x02,0x02,0x02,0x02,0xFE,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,
0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00
    },

    {
        0x14,0x44,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x40,0x40,0x40,0x40,0xC0,0x00,0x00,0xF8,0x08,0x08,0x08,0x08,0xF8,0x00,0x00,0xFF,0x01,0x01,0x01,0x01,0xFF,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0xF0,0x10,0x10,0x10,0x10,0xF0,0x00,0x00,0xFE,0x02,0x02,0x02,0x02,0xFE,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,
0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00
    },

    {
        0x14,0x44,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x40,0x40,0x40,0x40,0xC0,0x00,0x00,0xF8,0x08,0x08,0x08,0x08,0xF8,0x00,0x00,0xFF,0x01,0x01,0x01,0x01,0xFF,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0x00,0x00,0xFE,0x02,0x02,0x02,0x02,0xFE,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,
0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00
    },

    {
        0x14,0x44,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x40,0x40,0x40,0x40,0xC0,0x00,0x00,0xF8,0x08,0x08,0x08,0x08,0xF8,0x00,0x00,0xFF,0x01,0x01,0x01,0x01,0xFF,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0x00,0x00,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,
0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00
    },

    {
        0x14,0x44,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0xF8,0x08,0x08,0x08,0x08,0xF8,0x00,0x00,0xFF,0x01,0x01,0x01,0x01,0xFF,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0x00,0x00,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,
0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00
    },

    {
        0x14,0x44,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0x00,0x00,0xFF,0x01,0x01,0x01,0x01,0xFF,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0x00,0x00,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0x00,0x00,0x00,0x00,0xFF,0x00,0x00,
0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x08,0x08,0x08,0x08,0x0F,0x00,0x00
    },

    {
        0x14,0x44,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0xC0,0xC0,0xC0,0xC0,0xC0,0x00,0x00,0xF8,0xF8,0xF8,0xF8,0xF8,0xF8,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0xF0,0xF0,0xF0,0xF0,0xF0,0xF0,0x00,0x00,0xFE,0xFE,0xFE,0xFE,0xFE,0xFE,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x0E,0x0E,0x0E,0x0E,0x0E,0x0E,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00,0x0F,0x0F,0x0F,0x0F,0x0F,0x0F,0x00,0x00
    }
};


void TP_ShowCallEndDialog(uint8 *Phone,uint8 *CallTimes)
{
    uint8 TimerId = 0;
    TimerId = TP_TimerAllocate();
    TP_ScrCls();
    TP_ScrAttrSet(0);
    TP_ScrDrawRect(0, 0, 127, 63);
    TP_ShowTextSingleLine(3,8,126,62,CFONT,ALIGN_LEFT,(uchar*)"Call end\nCall number:%s\nCall time:%s",Phone,CallTimes);
    TP_TimerSet(TimerId, 2000);
    while(TP_TimerCheck(TimerId)!=0)
    {
        if(TP_Kbhit())
        {
            TP_Kbflush();
            TP_TimerFree(TimerId);
            break;
        }
    }
    TP_TimerFree(TimerId);

}


Boolean TP_CallInputNumber(uint8* outBuf, uint8 bufLen)
{
    uint8 KeyCode = 0;
    Boolean result = TRUE;
    uint8 str[256];
    uint8 cancellist[]={TP_KEY_ONHOOK};

    TP_ScrCls();

    TP_ScrGotoxyEx(3,3);
    TP_SetDisplayArea(3,3,126,15);
    TP_LcdPrintf((uint8*)"Please Input Phone:");

    TP_ScrDrawRect(3, 17, 125, 48);//Draw the input content's window
    TP_ScrAttrSet(0);
    TP_ScrGotoxyEx(3,49);
    TP_ScrFontSet(CFONT);
    TP_SetDisplayArea(1,48,126,63);
    TP_LcdPrintf((uint8*)"Confirm       Cancel");

    TP_ScrGotoxyEx(4,19);
    TP_SetDisplayArea(4,19,124,47);
    TP_SetInputModePosition(128, 64);
    TP_ShowInputNum(0, 0, 0);
    memset(str,0x00,sizeof(str));
    TP_BanIncomingCall(TRUE);

    TP_SetInputModeControlEx(KEY_DEMO_CONFIRM,
#if defined (TPS320)
                             TP_KEY_HANDFREE,
#else
                             TP_KEY_OK,
#endif
                             KEY_DEMO_CANCEL,
                             TP_KEY_CLEAR,
                             TP_KEY_NONE);
    TP_SetInputModeControlList(0, 0, cancellist, sizeof(cancellist));

    while(1)
    {
        KeyCode = TP_GetStringTimedEx((char*)str,0xF4,1,bufLen,3000,NULL);
        if(KeyCode == 0xFB || KeyCode == 0xF9)
        {
            if (strlen((char *)str) >0
                && strlen((char*)str) <= bufLen )
            {
                result = TRUE;
                break;
            }
        }
        else
        {
            memset(str,0,sizeof(str));
            result = FALSE;
            break;
        }

    }
    TP_ClearInputModeControlList();
    TP_BanIncomingCall(FALSE);
    if( strlen((char *)str) >0 )
    {
        memcpy(outBuf, str, strlen((char*)str));
    }
    return result;
}


/**************************************************************
* CallOrComing 0:call out 1:coming call
***************************************************************/
void TP_CallActive(Boolean CallOrComing, uint8 *Phone)
{
    uint8 str[256] = {0};
    uint8 CallTimes[10] = {0};
    uint8 KeyCode = TP_KEY_NONE;
    int32 volume = 0;
    char *tempstr = 0;
    Boolean SpecDTMFSend = TRUE;

    TP_ScrCls();
    TP_Kbflush();
    TP_ShowTextSingleLine(3,8,126,31,CFONT,
                          ALIGN_LEFT,(uint8 *)"Dial \n%s",Phone);
    TP_TimerSet(2, 0);
    TP_TimerSet(3, 0);
    while (TRUE)
    {
        if( CallOrComing == FALSE )
        {
            TP_NotifyCheck();
        }
        if(TP_IsHookOff())
        {
            TP_ScrSetIcon(ICON_PHONE,OFFHOOKICON);
        }
        else
        {
            TP_ScrSetIcon(ICON_PHONE,ONHOOKICON);
        }
        //TP_DbgSerialPrn("\r\n CallStatus:%d",TP_GetCallStatus());
        switch (TP_GetCallStatus())
        {
            case TP_CALLING ://Dialing
                TP_ShowTextSingleLine(3,8,126,31,CFONT,
                                      ALIGN_LEFT,(uint8 *)"Dial \n%s",Phone);
                break;
            case TP_WAITING ://Wait for connecting
            case TP_INCOMING:
                TP_ShowTextSingleLine(3,8,126,31,CFONT,
                                      ALIGN_LEFT,(uint8 *)"Waiting \n%s",Phone);
                break;
            case TP_CALLCONNECTED://Connected
                if( CallOrComing == FALSE )
                {
                    TP_ShowTextSingleLine(3,8,126,31,CFONT,
                                          ALIGN_LEFT,(uint8 *)"Call:\n%s",Phone);
                }
                else
                {
                    TP_ShowTextSingleLine(3,8,126,31,CFONT,
                                          ALIGN_LEFT,(uint8 *)"Coming:\n%s",Phone);
                }
                memset(CallTimes,0,sizeof(CallTimes));
                TP_GetFormatCallTime(CallTimes);
                TP_ShowTextSingleLine(3,32,126,43,CFONT,ALIGN_LEFT,CallTimes);

                break;
            case TP_CALLFAIL:

                TP_HangUp();
                break;
            case TP_HANGUP:
                TP_HangUp();
                #ifdef INCLUDE_CALL_RECORD
                UpdateCallRecordInfo((CallOrComing==FALSE)?0:1);
                #endif
                TP_ScrCls();//Clear the screen
                TP_GetFormatCallTime(CallTimes);
                TP_ShowCallEndDialog(Phone,CallTimes);
                TP_ScrSetIcon(ICON_PHONE,CLOSEICON);
                return;
                break;

        }

        ///Key Operation
        tempstr = 0;
        KeyCode = TP_KEY_NONE;
        if (TP_Kbhit())
        {
            KeyCode = TP_GetKey();

            switch (KeyCode)
            {
                case TP_KEY_HANDFREE: //Under this situation, on-hook
                case TP_KEY_CANCEL:
                case TP_KEY_ONHOOK:
                    TP_HangUp();
                    break;

                case TP_KEY_UP:
                case TP_KEY_RIGHT:
                    volume = TP_GetVolume(SPEECH_VOLUMN);
                    if(volume >= VOLUME_7)
                    {
                        volume = VOLUME_7;
                    }
                    else
                    {
                        volume++;
                    }
                    TP_SetVolume(SPEECH_VOLUMN, volume);
                    #ifdef INCLUDE_PHONE_SETTING
                    TP_SetParamItem(NAME_PARAMS(SpeakerVolumn),VAT_Int32,&volume);
                    #endif

                    TP_TimerSet(2, 2000);
                    break;

                case TP_KEY_DOWN:
                case TP_KEY_LEFT:
                    volume = TP_GetVolume(SPEECH_VOLUMN);
                    if(volume <= VOLUME_0)
                    {
                        volume = VOLUME_0;
                    }
                    else
                    {
                        volume--;
                    }
                    TP_SetVolume(SPEECH_VOLUMN, volume);
                    #ifdef INCLUDE_PHONE_SETTING
                    TP_SetParamItem(NAME_PARAMS(SpeakerVolumn),VAT_Int32,&volume);
                    #endif

                    TP_TimerSet(2, 2000);
                    break;
                case TP_KEY_1 :
                    //strcat((char *)str,"1");
                    tempstr = "1";
                    //TP_SendDtmf(KeyCode);
                    break;
                case TP_KEY_2  :
                    //strcat((char *)str,"2");
                    tempstr = "2";
                    //TP_SendDtmf(KeyCode);
                    break;
                case TP_KEY_3  :
                    //strcat((char *)str,"3");
                    tempstr = "3";
                    //TP_SendDtmf(KeyCode);
                    break;
                case TP_KEY_4  :
                    //strcat((char *)str,"4");
                    tempstr = "4";
                    //TP_SendDtmf(KeyCode);
                    break;
                case TP_KEY_5  :
                    //strcat((char *)str,"5");
                    tempstr = "5";
                    //TP_SendDtmf(KeyCode);
                    break;
                case TP_KEY_6  :
                    //strcat((char *)str,"6");
                    tempstr = "6";
                    //TP_SendDtmf(KeyCode);
                    break;
                case TP_KEY_7  :
                    //strcat((char *)str,"7");
                    tempstr = "7";
                    //TP_SendDtmf(KeyCode);
                    break;
                case TP_KEY_8  :
                    //strcat((char *)str,"8");
                    tempstr = "8";
                    //TP_SendDtmf(KeyCode);
                    break;
                case TP_KEY_9  :
                    //strcat((char *)str,"9");
                    tempstr = "9";
                    //TP_SendDtmf(KeyCode);
                    break;
                case TP_KEY_0  :
                    //strcat((char *)str,"0");
                    tempstr = "0";
                    //TP_SendDtmf(KeyCode);
                    break;
                case TP_KEY_STAR  :
                    //strcat((char *)str,"*");
                    #ifdef TPS300
                    if(TP_TimerCheck(3) == 0)
                    {
                        tempstr = "*";
                        TP_TimerSet(3, 1000);
                        SpecDTMFSend = FALSE;
                    }
                    else
                    {
                        uint8 index = strlen((char*)str)-1;
                        if(str[index] == '*')
                        {
                            str[index] = '#';
                            TP_TimerSet(3, 1000);
                            SpecDTMFSend = FALSE;
                        }
                        else if(str[index] == '#')
                        {
                            str[index] = '*';
                            TP_TimerSet(3, 1000);
                            SpecDTMFSend = FALSE;
                        }

                    }
                    #else
                    tempstr = "*";
                    //TP_SendDtmf(KeyCode);
                    #endif
                    break;
                case TP_KEY_POUND :
                    //strcat((char *)str,"#");
                    tempstr = "#";
                    //TP_SendDtmf(KeyCode);
                    break;
            }
        }
        #ifdef TPS300
        if(KeyCode != TP_KEY_NONE
           && KeyCode != TP_KEY_STAR )
        {
            if(TP_TimerCheck(3) > 0)
            {
                TP_TimerSet(3, 0);
            }
        }
        if(TP_TimerCheck(3) == 0)
        {
            if(SpecDTMFSend == FALSE)
            {
                uint8 index = strlen((char*)str)-1;
                if(str[index] == '*')
                {
                    TP_SendDtmf(TP_KEY_STAR);
                }
                else if(str[index] == '#')
                {
                    TP_SendDtmf(TP_KEY_POUND);
                }
                SpecDTMFSend = TRUE;
            }
        }
        if(tempstr != PNULL)
        {
            if(tempstr[0] != '*')
            {
                TP_SendDtmf(KeyCode);
            }
        }
        #else
        if(tempstr != PNULL)
        {
            TP_SendDtmf(KeyCode);
        }
        #endif

        if(KeyCode != TP_KEY_NONE
           && KeyCode != TP_KEY_UP
           && KeyCode != TP_KEY_DOWN
           && KeyCode != TP_KEY_LEFT
           && KeyCode != TP_KEY_RIGHT )
        {
            TP_TimerSet(2, 0);
        }

        if(tempstr != 0)
        {
            if(strlen((char *)str) < (sizeof(str)-2))
            {
                strcat((char *)str,tempstr);
            }
            else
            {
                //ÂuÊ±ÄuÈÝÒÆÇ°Ò»¸n
                memmove(&str[0], &str[1], sizeof(str)-1);
                strcat((char *)str,tempstr);
            }
        }
        if(TP_TimerCheck(2) > 0 )
        {
            volume = TP_GetVolume(SPEECH_VOLUMN);
            TP_ShowPicture(3,44,126,63,&SpeechVolume[volume][0]);
        }
        else
        {
            TP_ScrGotoxyEx(3,44);
            TP_ScrFontSet(CFONT);
            TP_SetDisplayArea(3,44,126,63);
            TP_ScrClsDisplayArea();

            if (strlen((char *)str) >0 && strlen((char *)str)<sizeof(str))
            {
                uint8 maxcharinrow = 0,maxrow=0;
                maxcharinrow = TP_GetMaxCharInRow();
                maxrow = TP_GetMaxRowInScreen();
                if (strlen((char *)str) > maxcharinrow*maxrow)
                {
                    TP_ShowTextSingleLine(3,44,126,63,CFONT,
                                          ALIGN_LEFT,&str[strlen((char *)str)-maxcharinrow*maxrow]);
                }
                else
                {
                    TP_ShowTextSingleLine(3,44,126,63,CFONT,ALIGN_LEFT,str);
                }
            }
        }
    }
}

void TP_ShowDialDilog(uint8 *Phone)
{
    uint8 str[20] = {0};

    TP_ScrCls();

    if(Phone==0 || strlen((char *)(char*)Phone)==0)
    {
        if( TP_CallInputNumber(str, 19) == FALSE )
        {
            TP_HangUp();
            return;
        }
    }
    else
    {
        memcpy(str,Phone,strlen((char*)Phone));
    }
    TP_CallOut((char *)str);

#ifdef INCLUDE_CALL_RECORD
    NewCallRecordInfo(0,str);
#endif
    TP_CallActive(FALSE, str);
}



///off-hook on-hook

void TP_PhoneHookUp()
{
    TP_HookUp();
    TP_ShowDialDilog(0);
}


void TP_PhoneHungUp()
{
    TP_HangUp();
}


void TP_ShowIncomingDilog()
{
    uint8 str[256];
    uint8 CallTimes[10];
    uint8 KeyCode;
    uint8 Loop;
    uint8 volume = 0;
    uint8 callstatus = 0;

#ifdef INCLUDE_PHONE_SETTING
    int32 ringType = 0;

    if (TP_GetParamItem(NAME_PARAMS(RingType),VAT_Int32,(void *)&ringType) == TRUE)
    {
        TP_PlayRing(ringType);
    }
    else
    {
        TP_PlayRing(3);
    }
#else
    TP_PlayRing(3);
#endif
    TP_ScrCls();

    TP_ScrDrawRect(0, 0, 127, 63);//Draw the window's border

    TP_ShowTextSingleLine(3,3,126,15,CFONT,ALIGN_LEFT,(uint8 *)"Incoming Call");


    memset(str,0,sizeof(str));
    memset(CallTimes,0,sizeof(CallTimes));
    TP_GetInComingPhone((char *)str);

    TP_ShowTextSingleLine(3,17,126,29,CFONT,ALIGN_LEFT,str);

    TP_ShowTextSingleLine(3,49,126,62,CFONT,ALIGN_LEFT,(uint8 *)"Confirm       Cancel");

    TP_Kbflush();

    Loop = 1;
    while (Loop)
    {
        ///Key Operation
        if (TP_Kbhit())
        {
            KeyCode = TP_GetKey();

            switch (KeyCode)
            {
                case TP_KEY_HANDFREE:
                case TP_KEY_OFFHOOK:
                case KEY_DEMO_CONFIRM: //Under this situation, on-hook
                    TP_StopRing();
                    TP_AnswerPhone();
                    #ifdef INCLUDE_CALL_RECORD
                    NewCallRecordInfo(1,str);
                    #endif
                    Loop =0;
                    break;

                case TP_KEY_ONHOOK:
                case KEY_DEMO_CANCEL:
                    TP_StopRing();
                    #ifdef INCLUDE_CALL_RECORD
                    NewCallRecordInfo(1,str);
                    #endif
                    TP_HangUp();
                    #ifdef INCLUDE_CALL_RECORD
                    TP_JudgeIsNeedUpdateCallList(1);
                    #endif
                    return;
                    break;
            }
        }

        if (TP_GetCallStatus() == TP_HANGUP)
        {
            //Indicated that answer time out, then exit
            TP_StopRing();
            #ifdef INCLUDE_CALL_RECORD
            NewCallRecordInfo(2,str);
            #endif
            return;
        }

    }
    TP_CallActive(TRUE, str);

}


////Auto Dial Test
void TP_AutoDialTest()
{
    uint8 str[256];
    uint8 CallTimes[10];
    uint8 KeyCode;
    uint8 TimeStart =1;

    TP_Kbmute(0);
    TP_ScrCls();
    TP_ScrDrawRect(0, 0, 127, 63);//Draw the window's border
    TP_ScrAttrSet(0);


    memset(str, 0, sizeof(str));
    sprintf((char*)str, "%s", "10086");

    TP_Kbflush();

    TimeStart = 0;
    TP_TimerSet(1, 0);
    TP_HookUp();
    TP_TimerSet(2, 200);
    while (TP_TimerCheck(2) != 0);

    while (TRUE)
    {
        TP_ShowTextSingleLine(3,50,126,62,CFONT,ALIGN_LEFT,(uint8 *)"              Cancel");

        if (TimeStart == 0)
        {
            if (TP_TimerCheck(1) == 0)
            {
                TP_ScrCls();//Clear the screen
                TP_CallOut((char *)str);
                TP_TimerSet(1, 10000);
                TimeStart = 1;
            }
        }

        switch (TP_GetCallStatus())
        {
        case TP_CALLOUT:
        case TP_CALLING://Dialing
            TP_ScrDrawRect(0, 0, 127, 63);
            TP_ShowTextSingleLine(3,8,126,20,CFONT,ALIGN_LEFT,(uint8 *)"Dial %s",str);
            break;

        case TP_WAITING ://Wait for connection
            TP_ScrDrawRect(0, 0, 127, 63);//Draw the window's border
            TP_ShowTextSingleLine(3,8,126,20,CFONT,ALIGN_LEFT,(uint8 *)"Waiting ");
            break;

        case TP_CALLCONNECTED://Connected
            TP_ScrDrawRect(0, 0, 127, 63);//Draw the window's border
            TP_ShowTextSingleLine(3,8,126,20,CFONT,ALIGN_LEFT,(uint8 *)"Call");

            memset(CallTimes,0,sizeof(CallTimes));
            TP_GetFormatCallTime(CallTimes);

            TP_ShowTextSingleLine(3,21,126,33,CFONT,ALIGN_LEFT,CallTimes);

            if (TP_GetCallTime() == 10)
            {
                TP_HangUp();
            }
            break;

        case TP_CALLFAIL:
            TP_ScrDrawRect(0, 0, 127, 63);//Draw the window's border
            TP_ShowTextSingleLine(3,8,126,20,CFONT,ALIGN_LEFT,(uint8 *)"Call Failed");

            TP_HangUp();
            TP_TimerSet(2, 1000);
            while (TP_TimerCheck(2) != 0);
            TP_HookUp();
            TimeStart = 0;
            break;

        case TP_HANGUP:
            TP_ScrDrawRect(0, 0, 127, 63);//Draw the window's border
            TP_ShowTextSingleLine(3,8,126,20,CFONT,ALIGN_LEFT,(uint8 *)"Call End");

            TimeStart = 0;
            TP_TimerSet(2, 1000);
            while (TP_TimerCheck(2) != 0);
            TP_HookUp();
            break;
        }

        ///Key Operation
        if (TP_Kbhit() == 0xFF)
        {
            KeyCode = TP_GetKey();

            if (KeyCode == TP_KEY_CANCEL)
            {
                TP_Kbmute(1);

                TP_HangUp();

                TP_TimerSet(2, 200);
                while (TP_TimerCheck(2) != 0);

                TP_Kbflush();
                return;
            }
        }
    }
}


